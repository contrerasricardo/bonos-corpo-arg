<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ONs Hard Dollar ¬∑ Argentina</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Crimson+Pro:wght@400;600;700&display=swap');

:root {
  --bg: #fafbfc;
  --surface: #ffffff;
  --border: #e1e4e8;
  --text: #24292e;
  --muted: #586069;
  --ny: #0969da;
  --arg: #cf222e;
  --green: #1a7f37;
  --yellow: #9a6700;
  --hover: #f6f8fa;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  font-size: 13px;
  -webkit-font-smoothing: antialiased;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 20px 32px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 0 rgba(27,31,35,.04);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

h1 {
  font-family: 'Crimson Pro', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.5px;
}

.header-right {
  display: flex;
  gap: 12px;
  align-items: center;
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  padding: 4px 10px;
  background: #dafbe1;
  border: 1px solid #1a7f37;
  border-radius: 6px;
  color: #1a7f37;
  font-weight: 500;
}

.live-dot {
  width: 6px;
  height: 6px;
  background: #1a7f37;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.refresh-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  padding: 5px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}

.refresh-btn:hover {
  background: var(--hover);
  border-color: var(--muted);
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  padding: 5px 12px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}

.filter-btn:hover {
  border-color: var(--text);
  color: var(--text);
}

.filter-btn.active-ny {
  background: #ddf4ff;
  border-color: var(--ny);
  color: var(--ny);
}

.filter-btn.active-arg {
  background: #ffebe9;
  border-color: var(--arg);
  color: var(--arg);
}

.filter-btn.active-all {
  background: var(--hover);
  border-color: var(--text);
  color: var(--text);
}

.search-box {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px;
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  color: var(--text);
  outline: none;
  min-width: 240px;
  transition: border-color 0.15s;
}

.search-box:focus {
  border-color: var(--ny);
  box-shadow: 0 0 0 3px rgba(9,105,218,0.1);
}

.search-box::placeholder {
  color: var(--muted);
}

/* ‚ïê‚ïê‚ïê STATS BAR ‚ïê‚ïê‚ïê */
.stats {
  display: flex;
  gap: 24px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.stat {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.stat-label {
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 500;
}

.stat-value {
  font-family: 'Crimson Pro', serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.stat-value.ny { color: var(--ny); }
.stat-value.arg { color: var(--arg); }

/* ‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê */
.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 0;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: var(--surface);
  font-size: 12px;
}

thead {
  position: sticky;
  top: 121px;
  z-index: 50;
  background: var(--surface);
}

thead tr {
  border-bottom: 2px solid var(--border);
}

th {
  text-align: left;
  padding: 12px 16px;
  font-weight: 600;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  background: var(--surface);
  border-bottom: 2px solid var(--border);
}

th.sortable {
  cursor: pointer;
  user-select: none;
}

th.sortable:hover {
  color: var(--text);
}

th.right { text-align: right; }
th.center { text-align: center; }

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
}

tbody tr:hover {
  background: var(--hover);
}

tbody tr.hidden {
  display: none;
}

td {
  padding: 14px 16px;
  vertical-align: middle;
}

.ticker {
  font-weight: 600;
  color: var(--text);
  font-size: 13px;
}

.empresa {
  color: var(--text);
  font-weight: 500;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-ny {
  background: #ddf4ff;
  color: var(--ny);
  border: 1px solid #54aeff;
}

.badge-arg {
  background: #ffebe9;
  color: var(--arg);
  border: 1px solid #ff8182;
}

.badge-bullet {
  background: #f6f8fa;
  color: var(--muted);
  border: 1px solid var(--border);
}

.badge-sinkable {
  background: #fff8c5;
  color: var(--yellow);
  border: 1px solid #d4a72c;
}

.badge-live {
  background: #dafbe1;
  color: var(--green);
  border: 1px solid var(--green);
}

.badge-base {
  background: #f6f8fa;
  color: var(--muted);
  border: 1px solid var(--border);
}

.right { text-align: right; }
.center { text-align: center; }

.price {
  font-weight: 600;
  font-size: 13px;
}

.var-pos { color: var(--green); font-weight: 600; }
.var-neg { color: var(--arg); font-weight: 600; }
.var-neu { color: var(--muted); }

.tir { font-weight: 600; }

.paridad {
  font-weight: 600;
  font-size: 13px;
}

.paridad.high { color: var(--green); }
.paridad.low { color: var(--arg); }

.dias-pago {
  font-weight: 500;
}

.dias-pago.pronto {
  color: var(--yellow);
  font-weight: 600;
}

.vencimiento {
  color: var(--muted);
  font-size: 11px;
}

/* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
.empty {
  padding: 80px 32px;
  text-align: center;
  color: var(--muted);
}

.empty-title {
  font-family: 'Crimson Pro', serif;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}

/* ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê */
.footer {
  padding: 32px;
  text-align: center;
  color: var(--muted);
  font-size: 11px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  margin-top: 40px;
}

.footer a {
  color: var(--ny);
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

/* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
.loading {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(250,251,252,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.loading.show {
  display: flex;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--ny);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ‚ïê‚ïê‚ïê YIELD CURVE CHART ‚ïê‚ïê‚ïê */
.chart-section {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.chart-section.collapsed {
  max-height: 0;
}

.chart-section.expanded {
  max-height: 600px;
}

.chart-inner {
  padding: 24px 32px;
}

.chart-title {
  font-family: 'Crimson Pro', serif;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.chart-subtitle {
  font-size: 11px;
  color: var(--muted);
  margin-bottom: 16px;
}

.chart-legend {
  display: flex;
  gap: 20px;
  margin-bottom: 12px;
  font-size: 11px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.legend-line {
  width: 24px;
  height: 2px;
  border-radius: 1px;
}

#yield-curve-canvas {
  width: 100%;
  height: 380px;
  display: block;
}

.chart-toggle-btn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  padding: 5px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
  font-weight: 500;
}

.chart-toggle-btn:hover {
  background: var(--hover);
  border-color: var(--muted);
}

.chart-toggle-btn.active {
  background: #ddf4ff;
  border-color: var(--ny);
  color: var(--ny);
}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media (max-width: 1200px) {
  .stats {
    overflow-x: auto;
    padding-bottom: 8px;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 16px 20px;
  }
  
  h1 {
    font-size: 22px;
  }
  
  .controls {
    width: 100%;
  }
  
  .search-box {
    flex: 1;
    min-width: 0;
  }
  
  table {
    font-size: 11px;
  }
  
  th, td {
    padding: 10px 12px;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1>ONs Hard Dollar ¬∑ Argentina</h1>
    <div class="header-right">
      <div class="live-indicator">
        <div class="live-dot"></div>
        <span id="live-label">Conectando...</span>
      </div>
      <button class="chart-toggle-btn" id="chart-toggle-btn" onclick="toggleChart()">‚åá Curva de Rendimientos</button>
      <button class="refresh-btn" onclick="fetchNow()">‚Üª Actualizar</button>
    </div>
  </div>
  
  <div class="controls">
    <button class="filter-btn active-all" onclick="setFilter('all', this)">Todas</button>
    <button class="filter-btn" onclick="setFilter('ny', this)">Ley NY</button>
    <button class="filter-btn" onclick="setFilter('arg', this)">Ley ARG</button>
    <input class="search-box" id="search" placeholder="Buscar por ticker o empresa..." oninput="applyFilters()">
  </div>
  
  <div class="stats">
    <div class="stat">
      <div class="stat-label">Total Bonos</div>
      <div class="stat-value" id="stat-total">‚Äî</div>
    </div>
    <div class="stat">
      <div class="stat-label">TIR Prom. NY (ponderada)</div>
      <div class="stat-value ny" id="stat-tir-ny">‚Äî</div>
    </div>
    <div class="stat">
      <div class="stat-label">TIR Prom. ARG (ponderada)</div>
      <div class="stat-value arg" id="stat-tir-arg">‚Äî</div>
    </div>
    <div class="stat">
      <div class="stat-label">Spread Jurisd.</div>
      <div class="stat-value" id="stat-spread">‚Äî</div>
    </div>
    <div class="stat">
      <div class="stat-label">Canje (AL30D/C)</div>
      <div class="stat-value" id="stat-canje" style="color:#9a6700;">‚Äî</div>
    </div>
    <div class="stat">
      <div class="stat-label">√öltima Actualizaci√≥n</div>
      <div class="stat-value" id="stat-update" style="font-size:14px;">‚Äî</div>
    </div>
  </div>
</div>

<div class="chart-section collapsed" id="chart-section">
  <div class="chart-inner">
    <div style="display:flex; align-items:baseline; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:12px;">
      <div>
        <div class="chart-title">Curva de Rendimientos ¬∑ ONs Hard Dollar</div>
        <div class="chart-subtitle">Duration (a√±os) vs TIR (%) ¬∑ Excluye outliers (TIR > 20%) ¬∑ Hover sobre un punto para ver detalle</div>
      </div>
      <div style="display:flex; gap:6px;">
        <button class="filter-btn active-ny" id="curve-tab-ny"  onclick="setCurveTab('ny')">Ley NY</button>
        <button class="filter-btn active-arg" id="curve-tab-arg" onclick="setCurveTab('arg')">Ley ARG</button>
        <button class="filter-btn active-all" id="curve-tab-all" onclick="setCurveTab('all')">Ambas</button>
      </div>
    </div>
    <canvas id="yield-curve-canvas"></canvas>
  </div>
</div>

<div class="container">
  <table id="table">
    <thead>
      <tr>
        <th class="sortable" onclick="sortBy('ticker')">Ticker</th>
        <th class="sortable" onclick="sortBy('empresa')">Empresa</th>
        <th class="center">Ley</th>
        <th class="right sortable" onclick="sortBy('precio')">Precio</th>
        <th class="right sortable" onclick="sortBy('var')">Var %</th>
        <th class="right sortable" onclick="sortBy('tir')">TIR</th>
        <th class="right sortable" onclick="sortBy('cupon')">Cup√≥n</th>
        <th class="right sortable" onclick="sortBy('duration')">Duration</th>
        <th class="right sortable" onclick="sortBy('paridad')">Paridad</th>
        <th class="right sortable" onclick="sortBy('dias_pago')">D√≠as P.Pago</th>
        <th class="right sortable" onclick="sortBy('vencimiento')">Vencimiento</th>
        <th class="center">Tipo</th>
        <th class="center">Estado</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Filled by JS -->
    </tbody>
  </table>
  
  <div id="empty-state" class="empty" style="display:none;">
    <div class="empty-title">Sin resultados</div>
    <p>No se encontraron bonos que coincidan con tu b√∫squeda.</p>
  </div>
</div>

<div class="footer">
  Datos en vivo de <a href="https://data912.com" target="_blank">data912.com</a> ¬∑ 
  Actualizaci√≥n autom√°tica cada 30s ¬∑ 
  83 ONs Hard Dollar verificadas
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA ‚Äî 34 NY + 49 ARG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BASE_NY = [
  {ticker:"MTCGD", empresa:"Mastellone", precio:104.65, var:0.05, tir:2.29, cupon:10.95, vencimiento:"30/06/2026", duration:0.36, tipo:"Bullet", paridad:103.02, ley:"NY", frecuencia:"Trimestral", dias_prox_cupon:39},
  {ticker:"PNDCD", empresa:"Pan American Energy", precio:66.00, var:0.79, tir:-1.16, cupon:9.13, vencimiento:"30/04/2027", duration:0.68, tipo:"Sinkable", paridad:105.95, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:70},
  {ticker:"YCAMD", empresa:"YPF", precio:104.00, var:0.00, tir:4.50, cupon:6.95, vencimiento:"21/07/2027", duration:1.38, tipo:"Bullet", paridad:103.40, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:152},
  {ticker:"IRCFD", empresa:"IRSA", precio:68.70, var:-0.29, tir:5.83, cupon:8.75, vencimiento:"22/06/2028", duration:1.44, tipo:"Sinkable", paridad:99.80, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:123},
  {ticker:"CAC5D", empresa:"Capex", precio:81.80, var:1.63, tir:5.48, cupon:9.25, vencimiento:"25/08/2028", duration:1.15, tipo:"Sinkable", paridad:104.27, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:61},
  {ticker:"BYCHD", empresa:"Banco Galicia", precio:108.55, var:-0.87, tir:5.46, cupon:7.75, vencimiento:"10/10/2028", duration:2.38, tipo:"Bullet", paridad:101.64, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:50},
  {ticker:"BACGD", empresa:"Banco Macro", precio:107.95, var:0.23, tir:5.86, cupon:8.00, vencimiento:"23/06/2029", duration:2.97, tipo:"Bullet", paridad:102.44, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:124},
  {ticker:"YMCID", empresa:"YPF", precio:107.90, var:-0.09, tir:5.23, cupon:9.00, vencimiento:"30/06/2029", duration:1.72, tipo:"Sinkable", paridad:106.52, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:131},
  {ticker:"DNC7D", empresa:"Edenor", precio:108.30, var:0.56, tir:8.26, cupon:9.75, vencimiento:"24/10/2030", duration:3.07, tipo:"Sinkable", paridad:104.92, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:64},
  {ticker:"RUCDD", empresa:"MSU Energy", precio:105.75, var:-0.70, tir:8.87, cupon:9.75, vencimiento:"05/12/2030", duration:3.87, tipo:"Sinkable", paridad:103.59, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:106},
  {ticker:"TLCMD", empresa:"Telecom", precio:111.90, var:0.40, tir:6.68, cupon:9.50, vencimiento:"18/07/2031", duration:3.70, tipo:"Sinkable", paridad:110.93, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:149},
  {ticker:"TSC3D", empresa:"TGS", precio:109.45, var:0.18, tir:6.65, cupon:8.50, vencimiento:"24/07/2031", duration:4.47, tipo:"Bullet", paridad:108.76, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:155},
  {ticker:"TTCDD", empresa:"Tecpetrol", precio:106.80, var:0.33, tir:6.59, cupon:7.63, vencimiento:"30/11/2030", duration:4.01, tipo:"Bullet", paridad:104.42, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:73},
  {ticker:"BACHD", empresa:"Banco Macro", precio:106.00, var:0.38, tir:6.78, cupon:8.00, vencimiento:"28/01/2031", duration:4.22, tipo:"Bullet", paridad:105.47, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:159},
  {ticker:"PLC5D", empresa:"Pluspetrol", precio:107.80, var:0.14, tir:6.92, cupon:8.13, vencimiento:"18/05/2031", duration:4.30, tipo:"Bullet", paridad:105.59, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:88},
  {ticker:"ARC1D", empresa:"Aeropuertos 2000", precio:106.45, var:-0.33, tir:6.12, cupon:8.50, vencimiento:"01/08/2031", duration:2.98, tipo:"Sinkable", paridad:105.97, ley:"NY", frecuencia:"Trimestral", dias_prox_cupon:71},
  {ticker:"MGCMD", empresa:"Pampa Energ√≠a", precio:110.45, var:-0.23, tir:6.56, cupon:7.95, vencimiento:"10/09/2031", duration:4.47, tipo:"Bullet", paridad:102.59, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:19},
  {ticker:"YMCXD", empresa:"YPF", precio:111.50, var:-0.31, tir:7.03, cupon:8.75, vencimiento:"11/09/2031", duration:3.99, tipo:"Sinkable", paridad:107.28, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:20},
  {ticker:"PNXCD", empresa:"Pan American Energy", precio:112.75, var:-1.10, tir:6.27, cupon:8.50, vencimiento:"30/04/2032", duration:4.88, tipo:"Sinkable", paridad:109.82, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:70},
  {ticker:"YFCJD", empresa:"YPF LUZ", precio:107.15, var:-0.74, tir:7.04, cupon:7.88, vencimiento:"16/10/2032", duration:4.55, tipo:"Sinkable", paridad:100.35, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:56},
  {ticker:"PLC4D", empresa:"Pluspetrol", precio:108.85, var:-0.09, tir:7.23, cupon:8.50, vencimiento:"30/05/2032", duration:4.93, tipo:"Bullet", paridad:106.78, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:100},
  {ticker:"TTCAD", empresa:"Tecpetrol", precio:107.00, var:-0.37, tir:6.40, cupon:7.63, vencimiento:"22/01/2033", duration:5.50, tipo:"Sinkable", paridad:106.35, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:153},
  {ticker:"YMCJD", empresa:"YPF", precio:104.85, var:-0.62, tir:6.68, cupon:7.00, vencimiento:"30/09/2033", duration:4.91, tipo:"Sinkable", paridad:102.01, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:39},
  {ticker:"TLCPD", empresa:"Telecom", precio:112.15, var:-0.09, tir:7.48, cupon:9.25, vencimiento:"28/05/2033", duration:5.13, tipo:"Sinkable", paridad:109.78, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:98},
  {ticker:"VSCVD", empresa:"VIsta Energy", precio:110.15, var:-0.32, tir:6.93, cupon:8.50, vencimiento:"10/06/2033", duration:4.96, tipo:"Sinkable", paridad:108.31, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:111},
  {ticker:"GN49D", empresa:"Genneia", precio:105.75, var:0.71, tir:7.11, cupon:7.75, vencimiento:"02/12/2033", duration:5.38, tipo:"Sinkable", paridad:103.98, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:103},
  {ticker:"YM34D", empresa:"YPF", precio:107.00, var:-0.23, tir:7.23, cupon:8.25, vencimiento:"17/01/2034", duration:5.43, tipo:"Sinkable", paridad:106.17, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:148},
  {ticker:"MGCOD", empresa:"Pampa Energ√≠a", precio:107.05, var:0.05, tir:7.13, cupon:7.88, vencimiento:"16/12/2034", duration:6.47, tipo:"Bullet", paridad:105.53, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:117},
  {ticker:"IRCPD", empresa:"IRSA", precio:108.70, var:-0.69, tir:7.20, cupon:8.00, vencimiento:"31/03/2035", duration:6.47, tipo:"Sinkable", paridad:105.35, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:40},
  {ticker:"TSC4D", empresa:"TGS", precio:106.75, var:-0.05, tir:7.19, cupon:7.75, vencimiento:"20/11/2035", duration:7.00, tipo:"Bullet", paridad:104.70, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:90},
  {ticker:"VSCTD", empresa:"VIsta Energy", precio:106.65, var:0.00, tir:6.95, cupon:7.63, vencimiento:"10/12/2035", duration:6.49, tipo:"Bullet", paridad:105.05, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:111},
  {ticker:"TLCTD", empresa:"Telecom", precio:108.00, var:0.14, tir:7.54, cupon:8.50, vencimiento:"20/01/2036", duration:6.66, tipo:"Sinkable", paridad:107.23, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:151},
  {ticker:"PN43D", empresa:"Pan American Energy", precio:104.90, var:-0.24, tir:7.29, cupon:7.75, vencimiento:"15/01/2037", duration:7.50, tipo:"Sinkable", paridad:104.10, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:146},
  {ticker:"MGCRD", empresa:"Pampa Energ√≠a", precio:106.40, var:-0.23, tir:7.33, cupon:7.75, vencimiento:"14/11/2037", duration:7.78, tipo:"Bullet", paridad:104.20, ley:"NY", frecuencia:"Semestral", dias_prox_cupon:84}
];

const BASE_ARG = [
  {ticker:"YMCVD", empresa:"YPF", precio:102.60, var:0.39, tir:1.38, cupon:6.00, vencimiento:"26/05/2026", duration:0.27, tipo:"Bullet", paridad:101.20, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:9},
  {ticker:"NBS1D", empresa:"Balanz", precio:100.25, var:-0.35, tir:4.86, cupon:5.00, vencimiento:"06/06/2026", duration:0.29, tipo:"Bullet", paridad:100.06, ley:"ARG", frecuencia:"Cuatrimestral", dias_prox_cupon:107},
  {ticker:"RC2CD", empresa:"Arcor", precio:103.20, var:0.10, tir:4.32, cupon:5.90, vencimiento:"06/10/2026", duration:0.62, tipo:"Bullet", paridad:100.96, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:46},
  {ticker:"DNC3D", empresa:"Edenor", precio:104.10, var:-0.29, tir:7.50, cupon:9.75, vencimiento:"22/11/2026", duration:0.74, tipo:"Bullet", paridad:101.66, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:92},
  {ticker:"YM41D", empresa:"YPF", precio:102.30, var:0.29, tir:4.21, cupon:6.00, vencimiento:"08/01/2027", duration:0.87, tipo:"Bullet", paridad:101.58, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:48},
  {ticker:"ZZC1D", empresa:"Camuzzi", precio:105.40, var:0.38, tir:6.58, cupon:7.95, vencimiento:"21/02/2027", duration:0.96, tipo:"Bullet", paridad:101.36, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:2},
  {ticker:"IRCJD", empresa:"IRSA", precio:105.55, var:0.67, tir:4.85, cupon:7.00, vencimiento:"28/02/2027", duration:0.99, tipo:"Bullet", paridad:98.79, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:9},
  {ticker:"LMS8D", empresa:"Aluar", precio:104.40, var:1.56, tir:1.58, cupon:6.25, vencimiento:"21/03/2027", duration:0.70, tipo:"Sinkable", paridad:100.21, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:30},
  {ticker:"VSCWD", empresa:"Vista Energy", precio:102.50, var:0.10, tir:4.36, cupon:6.00, vencimiento:"15/04/2027", duration:1.13, tipo:"Bullet", paridad:101.90, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:55},
  {ticker:"PN42D", empresa:"Pan American Energy", precio:103.25, var:-0.05, tir:4.99, cupon:6.00, vencimiento:"17/04/2027", duration:1.13, tipo:"Bullet", paridad:101.15, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:57},
  {ticker:"OTS2D", empresa:"Oil Tanking", precio:101.90, var:-0.10, tir:5.90, cupon:7.00, vencimiento:"24/04/2027", duration:1.15, tipo:"Bullet", paridad:101.38, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:64},
  {ticker:"YM37D", empresa:"YPF", precio:102.60, var:0.15, tir:5.07, cupon:7.00, vencimiento:"07/05/2027", duration:1.18, tipo:"Bullet", paridad:102.34, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:77},
  {ticker:"RCCRD", empresa:"Arcor", precio:104.40, var:0.00, tir:4.66, cupon:6.75, vencimiento:"09/05/2027", duration:1.19, tipo:"Bullet", paridad:102.45, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:79},
  {ticker:"CIC9D", empresa:"CNH Industrial", precio:102.00, var:0.00, tir:8.45, cupon:8.25, vencimiento:"21/05/2027", duration:1.20, tipo:"Bullet", paridad:96.03, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:91},
  {ticker:"HJCID", empresa:"John Deere", precio:102.35, var:0.00, tir:7.10, cupon:7.50, vencimiento:"27/05/2027", duration:1.22, tipo:"Bullet", paridad:100.59, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:97},
  {ticker:"MCC2D", empresa:"PECOM", precio:101.00, var:-0.88, tir:8.19, cupon:7.50, vencimiento:"02/06/2027", duration:1.24, tipo:"Bullet", paridad:98.77, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:103},
  {ticker:"PFC2D", empresa:"Profertil", precio:102.25, var:-0.24, tir:6.19, cupon:7.25, vencimiento:"14/07/2027", duration:1.36, tipo:"Bullet", paridad:101.50, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:145},
  {ticker:"YM38D", empresa:"YPF", precio:103.65, var:-0.05, tir:5.35, cupon:7.50, vencimiento:"22/07/2027", duration:1.36, tipo:"Bullet", paridad:103.03, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:62},
  {ticker:"MIC4D", empresa:"Mirgor", precio:101.50, var:0.69, tir:7.72, cupon:8.25, vencimiento:"29/07/2027", duration:1.38, tipo:"Bullet", paridad:101.00, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:69},
  {ticker:"PN38D", empresa:"Pan American Energy", precio:104.20, var:-1.70, tir:3.69, cupon:6.50, vencimiento:"11/08/2027", duration:1.43, tipo:"Bullet", paridad:104.03, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:173},
  {ticker:"SBC1D", empresa:"Scania Credit", precio:105.20, var:-0.75, tir:7.41, cupon:8.75, vencimiento:"05/09/2027", duration:0.76, tipo:"Sinkable", paridad:101.90, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:14},
  {ticker:"TTCBD", empresa:"Tecpetrol", precio:104.00, var:-0.29, tir:5.45, cupon:6.50, vencimiento:"16/10/2027", duration:1.58, tipo:"Bullet", paridad:101.70, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:56},
  {ticker:"RUCED", empresa:"MSU Energy", precio:100.40, var:0.40, tir:7.59, cupon:7.50, vencimiento:"30/10/2027", duration:1.51, tipo:"Sinkable", paridad:100.17, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:70},
  {ticker:"TLCOD", empresa:"Telecom", precio:104.15, var:0.63, tir:6.08, cupon:7.00, vencimiento:"28/11/2028", duration:2.56, tipo:"Bullet", paridad:102.50, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:98},
  {ticker:"PLC3D", empresa:"Pluspetrol", precio:103.30, var:0.54, tir:5.92, cupon:7.25, vencimiento:"30/04/2028", duration:2.08, tipo:"Bullet", paridad:102.87, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:161},
  {ticker:"CRCJD", empresa:"Celulosa", precio:17.60, var:0.00, tir:284.52, cupon:9.25, vencimiento:"16/05/2028", duration:1.80, tipo:"Sinkable", paridad:25.57, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:86},
  {ticker:"OLC5D", empresa:"Oleoductos del Valle", precio:105.00, var:0.00, tir:6.34, cupon:7.89, vencimiento:"12/06/2028", duration:2.16, tipo:"Bullet", paridad:103.43, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:113},
  {ticker:"CICAD", empresa:"CNH Industrial", precio:102.50, var:0.49, tir:7.76, cupon:8.00, vencimiento:"03/06/2028", duration:2.14, tipo:"Bullet", paridad:100.76, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:104},
  {ticker:"DNC5D", empresa:"Edenor", precio:105.15, var:-0.61, tir:7.48, cupon:9.50, vencimiento:"05/08/2028", duration:2.25, tipo:"Bullet", paridad:104.74, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:167},
  {ticker:"YM40D", empresa:"YPF", precio:105.80, var:-0.14, tir:5.88, cupon:7.50, vencimiento:"28/08/2028", duration:2.31, tipo:"Bullet", paridad:104.00, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:9},
  {ticker:"LMS7D", empresa:"Aluar", precio:95.30, var:0.63, tir:4.76, cupon:7.00, vencimiento:"12/10/2028", duration:1.34, tipo:"Sinkable", paridad:94.59, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:52},
  {ticker:"PECGD", empresa:"Petrolera Aconcagua", precio:62.76, var:0.00, tir:35.02, cupon:9.00, vencimiento:"28/10/2028", duration:2.27, tipo:"Bullet", paridad:61.03, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:68},
  {ticker:"PN37D", empresa:"Pan American Energy", precio:102.80, var:-0.53, tir:6.01, cupon:6.25, vencimiento:"13/11/2028", duration:2.54, tipo:"Bullet", paridad:101.09, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:83},
  {ticker:"SBC2D", empresa:"Scania Credit", precio:101.25, var:0.15, tir:7.32, cupon:7.49, vencimiento:"16/01/2029", duration:1.58, tipo:"Sinkable", paridad:100.53, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:147},
  {ticker:"HJCKD", empresa:"John Deere", precio:103.00, var:-0.96, tir:6.99, cupon:7.75, vencimiento:"16/01/2029", duration:2.67, tipo:"Bullet", paridad:102.24, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:147},
  {ticker:"YM42D", empresa:"YPF", precio:103.05, var:0.15, tir:6.55, cupon:7.00, vencimiento:"02/03/2029", duration:2.77, tipo:"Bullet", paridad:101.49, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:103},
  {ticker:"VSCPD", empresa:"Vista Energy", precio:107.80, var:0.89, tir:5.67, cupon:8.00, vencimiento:"03/05/2029", duration:2.25, tipo:"Sinkable", paridad:105.28, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:73},
  {ticker:"OLC6D", empresa:"Oleoductos del Valle", precio:103.20, var:-0.58, tir:7.06, cupon:7.50, vencimiento:"05/06/2029", duration:2.97, tipo:"Bullet", paridad:101.59, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:106},
  {ticker:"NPCCD", empresa:"Central Puerto", precio:108.80, var:-0.09, tir:6.53, cupon:8.00, vencimiento:"25/08/2029", duration:3.06, tipo:"Bullet", paridad:104.69, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:6},
  {ticker:"PN41D", empresa:"Pan American Energy", precio:107.85, var:0.33, tir:6.24, cupon:7.50, vencimiento:"27/08/2029", duration:3.09, tipo:"Bullet", paridad:104.07, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:8},
  {ticker:"PN35D", empresa:"Pan American Energy", precio:105.70, var:-0.75, tir:6.18, cupon:7.00, vencimiento:"27/09/2029", duration:3.16, tipo:"Bullet", paridad:99.41, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:36},
  {ticker:"IRCOD", empresa:"IRSA", precio:103.10, var:-0.43, tir:6.57, cupon:7.25, vencimiento:"23/10/2029", duration:3.31, tipo:"Bullet", paridad:102.53, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:154},
  {ticker:"TTC9D", empresa:"Tecpetrol", precio:104.00, var:-0.43, tir:6.34, cupon:6.80, vencimiento:"24/10/2029", duration:3.25, tipo:"Bullet", paridad:101.74, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:64},
  {ticker:"OT42D", empresa:"Oil Tanking", precio:106.90, var:1.23, tir:6.36, cupon:8.00, vencimiento:"17/01/2030", duration:3.43, tipo:"Bullet", paridad:106.11, ley:"ARG", frecuencia:"Trimestral", dias_prox_cupon:57},
  {ticker:"PLC2D", empresa:"Pluspetrol", precio:105.80, var:0.38, tir:6.61, cupon:7.50, vencimiento:"27/01/2030", duration:3.45, tipo:"Bullet", paridad:103.34, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:67},
  {ticker:"YM39D", empresa:"YPF", precio:109.75, var:0.87, tir:6.47, cupon:8.75, vencimiento:"22/07/2030", duration:3.74, tipo:"Bullet", paridad:108.98, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:153},
  {ticker:"PQCSD", empresa:"Petroquimica Cdro Riv", precio:100.95, var:-1.70, tir:7.93, cupon:8.00, vencimiento:"17/02/2031", duration:4.25, tipo:"Bullet", paridad:100.88, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:179},
  {ticker:"VSCRD", empresa:"Vista Energy", precio:107.70, var:0.33, tir:6.51, cupon:7.65, vencimiento:"10/10/2031", duration:4.57, tipo:"Sinkable", paridad:101.01, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:50},
  {ticker:"PN36D", empresa:"Pan American Energy", precio:105.30, var:-0.09, tir:6.65, cupon:7.25, vencimiento:"13/11/2031", duration:4.70, tipo:"Bullet", paridad:99.70, ley:"ARG", frecuencia:"Semestral", dias_prox_cupon:83}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL_CORP = 'https://bonos-corp-arg.contrerasaricardo.workers.dev/arg_corp';
const API_URL_BONDS = 'https://bonos-corp-arg.contrerasaricardo.workers.dev/arg_bonds';
let data = [...BASE_NY, ...BASE_ARG].map(d => ({ ...d, live: false }));
let currentFilter = 'all';
let sortField = 'ticker';
let sortAsc = true;
let searchQuery = '';
let refreshInterval = null;

// Canje (AL30D/AL30C) - se actualiza autom√°ticamente desde API
let al30d_precio = null;
let al30c_precio = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API FETCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchAPI() {
  console.log('üîÑ Fetching data from:', API_URL_CORP);
  console.log('üîÑ Fetching canje from:', API_URL_BONDS);
  document.getElementById('loading').classList.add('show');
  
  try {
    // Fetch corporates (removed AbortSignal - causing DataCloneError in some browsers)
    const resCorp = await fetch(API_URL_CORP, { 
      mode: 'cors'
    });
    
    if (!resCorp.ok) {
      throw new Error(`HTTP ${resCorp.status}: ${resCorp.statusText}`);
    }
    
    const corpData = await resCorp.json();
    console.log('‚úÖ Corp API Response:', corpData.length, 'instruments');
    
    if (!Array.isArray(corpData)) {
      throw new Error('Invalid corp response format (expected array)');
    }

    // Fetch sovereign bonds for canje
    let bondsData = [];
    try {
      const resBonds = await fetch(API_URL_BONDS, { 
        mode: 'cors'
      });
      if (resBonds.ok) {
        bondsData = await resBonds.json();
        console.log('‚úÖ Bonds API Response:', bondsData.length, 'instruments');
      }
    } catch (e) {
      console.warn('‚ö†Ô∏è Bonds API failed (canje will use manual values):', e.message);
    }

    // Build price map from corporates
    const priceMap = {};
    corpData.forEach(item => {
      if (item.symbol && item.c > 0) {
        priceMap[item.symbol] = {
          precio: item.c,
          var: item.pct_change || 0
        };
      }
    });
    
    console.log('üìä Price map built:', Object.keys(priceMap).length, 'symbols');
    console.log('üìã Sample API tickers:', Object.keys(priceMap).slice(0, 10));
    console.log('üìã Our first 5 tickers:', data.slice(0, 5).map(d => d.ticker));

    // Extract AL30D and AL30C from bonds
    bondsData.forEach(item => {
      if (item.symbol === 'AL30D' && item.c > 0) {
        al30d_precio = item.c;
      }
      if (item.symbol === 'AL30C' && item.c > 0) {
        al30c_precio = item.c;
      }
    });
    
    if (al30d_precio && al30c_precio) {
      console.log('üí± Canje data:', { AL30D: al30d_precio, AL30C: al30c_precio });
    }

    // Merge corporate data
    let matchCount = 0;
    data = data.map(bond => {
      const live = priceMap[bond.ticker];
      if (live) {
        matchCount++;
        
        // Calculate live parity from price (paridad ‚âà precio para bonds)
        const liveParidad = live.precio;
        
        console.log(`‚úì Matched ${bond.ticker} ‚Üí $${live.precio.toFixed(2)} (Paridad: ${liveParidad.toFixed(2)}%)`);
        
        return { 
          ...bond, 
          precio: live.precio, 
          var: live.var,
          paridad: liveParidad,  // Update parity with live price
          live: true 
        };
      }
      return { ...bond, live: false };
    });
    
    console.log('‚úÖ Matched:', matchCount, 'bonds with live prices');
    document.getElementById('live-label').textContent = `Live ¬∑ ${matchCount} actualizados`;
    document.getElementById('stat-update').textContent = new Date().toLocaleTimeString('es-AR');
    
  } catch (e) {
    console.error('‚ùå API Error:', e);
    console.error('Error details:', e.message);
    
    // Visual feedback
    document.getElementById('live-label').textContent = 'Error de conexi√≥n';
    document.getElementById('live-label').style.background = '#ffebe9';
    document.getElementById('live-label').style.borderColor = '#cf222e';
    document.getElementById('live-label').style.color = '#cf222e';
    
    // Show alert if first load
    if (!data[0].live) {
      console.warn('‚ö†Ô∏è Usando datos base - API no disponible');
    }
    
  } finally {
    document.getElementById('loading').classList.remove('show');
    render();
  }
}

function fetchNow() {
  fetchAPI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULATE DAYS TO NEXT PAYMENT (auto-update daily)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcularDiasProximoPago(vencimientoStr, frecuencia = 'semestral') {
  // Parse vencimiento "DD/MM/YYYY"
  const [dia, mes, a√±o] = vencimientoStr.split('/').map(Number);
  const vencimiento = new Date(a√±o, mes - 1, dia);
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  // Si ya venci√≥, return -1
  if (hoy > vencimiento) return -1;
  
  // Calcular pr√≥xima fecha de pago (asumiendo pagos semestrales)
  const mesesEntrePagos = frecuencia === 'semestral' ? 6 : 12;
  let proximoPago = new Date(vencimiento);
  
  // Retroceder desde vencimiento hasta encontrar el pr√≥ximo pago futuro
  while (proximoPago > hoy) {
    proximoPago.setMonth(proximoPago.getMonth() - mesesEntrePagos);
  }
  
  // Avanzar al siguiente pago
  proximoPago.setMonth(proximoPago.getMonth() + mesesEntrePagos);
  
  // Calcular d√≠as
  const diffTime = proximoPago - hoy;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays > 0 ? diffDays : -1;
}

// Update all bonds with calculated days to next payment
function actualizarDiasPago() {
  data = data.map(bond => ({
    ...bond,
    dias_prox_cupon: calcularDiasProximoPago(bond.vencimiento, bond.frecuencia || 'semestral')
  }));
}

function render() {
  actualizarDiasPago(); // Recalcular d√≠as antes de renderizar
  renderStats();
  renderTable();
  if (chartVisible) drawYieldCurve();
}

function renderStats() {
  const nyBonds = data.filter(d => d.ley === 'NY' && d.tir > 0 && d.tir < 50);
  const argBonds = data.filter(d => d.ley === 'ARG' && d.tir > 0 && d.tir < 50);
  
  // Duration-weighted average TIR
  const weightedAvgTIR = (bonds) => {
    if (!bonds.length) return '‚Äî';
    const sumWeighted = bonds.reduce((sum, b) => sum + (b.tir * b.duration), 0);
    const sumDuration = bonds.reduce((sum, b) => sum + b.duration, 0);
    if (sumDuration === 0) return '‚Äî';
    return (sumWeighted / sumDuration).toFixed(2) + '%';
  };
  
  const nyAvg = weightedAvgTIR(nyBonds);
  const argAvg = weightedAvgTIR(argBonds);
  
  let spread = '‚Äî';
  if (nyAvg !== '‚Äî' && argAvg !== '‚Äî') {
    const diff = parseFloat(argAvg) - parseFloat(nyAvg);
    spread = (diff > 0 ? '+' : '') + diff.toFixed(2) + '%';
  }
  
  // Calcular Canje (AL30D / AL30C)
  let canje = '‚Äî';
  if (al30d_precio && al30c_precio && al30c_precio > 0) {
    const spread_pct = ((al30d_precio / al30c_precio - 1) * 100);
    canje = (spread_pct > 0 ? '+' : '') + spread_pct.toFixed(2) + '%';
  }
  
  document.getElementById('stat-total').textContent = data.length;
  document.getElementById('stat-tir-ny').textContent = nyAvg;
  document.getElementById('stat-tir-arg').textContent = argAvg;
  document.getElementById('stat-spread').textContent = spread;
  document.getElementById('stat-canje').textContent = canje;
}

function renderTable() {
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty-state');
  
  // Filter
  let filtered = data;
  
  // By jurisdiction
  if (currentFilter === 'ny') filtered = filtered.filter(d => d.ley === 'NY');
  if (currentFilter === 'arg') filtered = filtered.filter(d => d.ley === 'ARG');
  
  // By search
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    filtered = filtered.filter(d => 
      d.ticker.toLowerCase().includes(q) || 
      d.empresa.toLowerCase().includes(q)
    );
  }
  
  // Sort
  filtered.sort((a, b) => {
    let aVal = a[sortField];
    let bVal = b[sortField];
    
    // Special handling
    if (sortField === 'ticker' || sortField === 'empresa') {
      aVal = String(aVal).toLowerCase();
      bVal = String(bVal).toLowerCase();
      return sortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }
    
    return sortAsc ? aVal - bVal : bVal - aVal;
  });
  
  // Render
  if (!filtered.length) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  tbody.innerHTML = filtered.map(d => {
    const varClass = d.var > 0 ? 'var-pos' : d.var < 0 ? 'var-neg' : 'var-neu';
    const varSign = d.var > 0 ? '+' : '';
    // Paridad color: green if between 98-101%, red otherwise
    const paridadClass = (d.paridad >= 98 && d.paridad <= 101) ? 'paridad high' : 'paridad low';
    const diasClass = d.dias_prox_cupon <= 30 ? 'dias-pago pronto' : 'dias-pago';
    
    return `
      <tr>
        <td><span class="ticker">${d.ticker}</span></td>
        <td><span class="empresa">${d.empresa}</span></td>
        <td class="center"><span class="badge badge-${d.ley.toLowerCase()}">${d.ley}</span></td>
        <td class="right"><span class="price">$${d.precio.toFixed(2)}</span></td>
        <td class="right"><span class="${varClass}">${varSign}${d.var.toFixed(2)}%</span></td>
        <td class="right"><span class="tir">${d.tir.toFixed(2)}%</span></td>
        <td class="right">${d.cupon.toFixed(2)}%</td>
        <td class="right">${d.duration.toFixed(2)}y</td>
        <td class="right"><span class="${paridadClass}">${d.paridad.toFixed(2)}%</span></td>
        <td class="right"><span class="${diasClass}">${d.dias_prox_cupon}d</span></td>
        <td class="right"><span class="vencimiento">${d.vencimiento}</span></td>
        <td class="center"><span class="badge badge-${d.tipo.toLowerCase()}">${d.tipo}</span></td>
        <td class="center"><span class="badge badge-${d.live ? 'live' : 'base'}">${d.live ? 'LIVE' : 'BASE'}</span></td>
      </tr>
    `;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.className = 'filter-btn';
  });
  if (filter === 'ny') btn.className = 'filter-btn active-ny';
  else if (filter === 'arg') btn.className = 'filter-btn active-arg';
  else btn.className = 'filter-btn active-all';
  render();
}

function applyFilters() {
  searchQuery = document.getElementById('search').value;
  render();
}

function sortBy(field) {
  if (sortField === field) {
    sortAsc = !sortAsc;
  } else {
    sortField = field;
    sortAsc = true;
  }
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIELD CURVE CHART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chartVisible = false;
let curveTab = 'ny'; // 'ny' | 'arg' | 'all'

function setCurveTab(tab) {
  curveTab = tab;
  ['ny','arg','all'].forEach(t => {
    const btn = document.getElementById('curve-tab-' + t);
    btn.className = 'filter-btn' + (t === tab ? ` active-${t}` : '');
  });
  drawYieldCurve();
}

function toggleChart() {
  chartVisible = !chartVisible;
  const section = document.getElementById('chart-section');
  const btn = document.getElementById('chart-toggle-btn');
  if (chartVisible) {
    section.classList.remove('collapsed');
    section.classList.add('expanded');
    btn.classList.add('active');
    btn.textContent = '‚úï Cerrar Curva';
    drawYieldCurve();
  } else {
    section.classList.remove('expanded');
    section.classList.add('collapsed');
    btn.classList.remove('active');
    btn.textContent = '‚åá Curva de Rendimientos';
  }
}

// Regresi√≥n polin√≥mica por m√≠nimos cuadrados (igual que Excel "polynomial trendline")
// Grado 2 = par√°bola suave, nunca oscila, captura la forma creciente de la yield curve
function polyFit(xs, ys, degree) {
  const n = xs.length;
  const d = degree + 1;
  if (n < d) return null;

  // Construir sistema de ecuaciones normales X^T X Œ≤ = X^T y
  // Normalizar x para estabilidad num√©rica
  const xMean = xs.reduce((s, x) => s + x, 0) / n;
  const xStd  = Math.sqrt(xs.reduce((s, x) => s + (x - xMean) ** 2, 0) / n) || 1;
  const xn = xs.map(x => (x - xMean) / xStd);

  const A = Array.from({length: d}, () => new Array(d).fill(0));
  const b = new Array(d).fill(0);

  for (let k = 0; k < n; k++) {
    const pow = [];
    let p = 1;
    for (let j = 0; j < d; j++) { pow.push(p); p *= xn[k]; }
    for (let i = 0; i < d; i++) {
      for (let j = 0; j < d; j++) A[i][j] += pow[i] * pow[j];
      b[i] += pow[i] * ys[k];
    }
  }

  // Eliminaci√≥n gaussiana con pivoteo parcial
  for (let col = 0; col < d; col++) {
    let maxRow = col;
    for (let row = col + 1; row < d; row++)
      if (Math.abs(A[row][col]) > Math.abs(A[maxRow][col])) maxRow = row;
    [A[col], A[maxRow]] = [A[maxRow], A[col]];
    [b[col], b[maxRow]] = [b[maxRow], b[col]];
    if (Math.abs(A[col][col]) < 1e-14) return null;
    for (let row = col + 1; row < d; row++) {
      const f = A[row][col] / A[col][col];
      for (let j = col; j < d; j++) A[row][j] -= f * A[col][j];
      b[row] -= f * b[col];
    }
  }

  // Sustituci√≥n hacia atr√°s
  const coef = new Array(d).fill(0);
  for (let i = d - 1; i >= 0; i--) {
    coef[i] = b[i];
    for (let j = i + 1; j < d; j++) coef[i] -= A[i][j] * coef[j];
    coef[i] /= A[i][i];
  }

  return function(x) {
    const xnorm = (x - xMean) / xStd;
    let result = 0, p = 1;
    for (let j = 0; j < d; j++) { result += coef[j] * p; p *= xnorm; }
    return result;
  };
}

function drawYieldCurve() {
  const canvas = document.getElementById('yield-curve-canvas');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const W = rect.width;
  const H = rect.height;
  const PAD = { top: 24, right: 40, bottom: 46, left: 52 };
  const plotW = W - PAD.left - PAD.right;
  const plotH = H - PAD.top - PAD.bottom;

  // Filter valid data (exclude outliers: TIR > 20)
  const nyPoints  = data.filter(d => d.ley === 'NY'  && d.tir > 0 && d.tir < 20 && d.duration > 0);
  const argPoints = data.filter(d => d.ley === 'ARG' && d.tir > 0 && d.tir < 20 && d.duration > 0);

  // Puntos visibles seg√∫n tab ‚Äî ejes se ajustan a ellos
  const visiblePoints = curveTab === 'ny'  ? nyPoints
                      : curveTab === 'arg' ? argPoints
                      : [...nyPoints, ...argPoints];
  if (!visiblePoints.length) return;

  // Axis ranges ‚Äî tight, ajustado al tab activo
  const allX = visiblePoints.map(d => d.duration);
  const allY = visiblePoints.map(d => d.tir);
  const rawXMin = Math.min(...allX);
  const rawXMax = Math.max(...allX);
  const rawYMin = Math.min(...allY);
  const rawYMax = Math.max(...allY);

  // Ejes: ¬±0.5y en X y ¬±1% en Y sobre los datos reales
  let xMin = Math.max(0, rawXMin - 0.5);
  let xMax = rawXMax + 0.5;
  let yMin = Math.max(0, rawYMin - 1);
  let yMax = rawYMax + 1;

  // Ticks cada 0.5y en X y cada 0.5% en Y (fijo, prolijo)
  const xStep = 0.5;
  const yStep = 0.5;
  xMin = Math.floor(xMin / xStep) * xStep;
  xMax = Math.ceil(xMax  / xStep) * xStep;
  yMin = Math.floor(yMin / yStep) * yStep;
  yMax = Math.ceil(yMax  / yStep) * yStep;

  const toCanvasX = (x) => PAD.left + ((x - xMin) / (xMax - xMin)) * plotW;
  const toCanvasY = (y) => PAD.top  + plotH - ((y - yMin) / (yMax - yMin)) * plotH;

  // ‚îÄ‚îÄ Background ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, W, H);

  // ‚îÄ‚îÄ Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx.strokeStyle = '#e1e4e8';
  ctx.lineWidth = 1;

  for (let y = yMin; y <= yMax + 1e-9; y += yStep) {
    const cy = toCanvasY(y);
    ctx.beginPath();
    ctx.setLineDash([4, 4]);
    ctx.moveTo(PAD.left, cy);
    ctx.lineTo(PAD.left + plotW, cy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#586069';
    ctx.font = '10px IBM Plex Mono, monospace';
    ctx.textAlign = 'right';
    ctx.fillText(y.toFixed(yStep < 1 ? 1 : 0) + '%', PAD.left - 7, cy + 3.5);
  }

  for (let x = xMin; x <= xMax + 1e-9; x += xStep) {
    const cx = toCanvasX(x);
    ctx.beginPath();
    ctx.setLineDash([4, 4]);
    ctx.moveTo(cx, PAD.top);
    ctx.lineTo(cx, PAD.top + plotH);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#586069';
    ctx.font = '10px IBM Plex Mono, monospace';
    ctx.textAlign = 'center';
    ctx.fillText(x.toFixed(xStep < 1 ? 1 : 0) + 'y', cx, PAD.top + plotH + 16);
  }

  // ‚îÄ‚îÄ Axes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx.strokeStyle = '#9ea9b3';
  ctx.lineWidth = 1;
  ctx.setLineDash([]);
  ctx.beginPath();
  ctx.moveTo(PAD.left, PAD.top);
  ctx.lineTo(PAD.left, PAD.top + plotH);
  ctx.lineTo(PAD.left + plotW, PAD.top + plotH);
  ctx.stroke();

  // Axis labels
  ctx.fillStyle = '#586069';
  ctx.font = '11px IBM Plex Mono, monospace';
  ctx.textAlign = 'center';
  ctx.fillText('Duration (a√±os)', PAD.left + plotW / 2, H - 4);
  ctx.save();
  ctx.translate(13, PAD.top + plotH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('TIR (%)', 0, 0);
  ctx.restore();

  // ‚îÄ‚îÄ Trend line (dashed, like Excel forecast line) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function drawTrend(points, color) {
    if (points.length < 4) return;
    const xs = points.map(d => d.duration);
    const ys = points.map(d => d.tir);
    const fn = polyFit(xs, ys, 2);
    if (!fn) return;

    // Solo trazar entre el rango real de datos, sin extrapolaci√≥n
    const dataXMin = Math.min(...xs);
    const dataXMax = Math.max(...xs);

    const steps = 300;
    const dx = (dataXMax - dataXMin) / steps;
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.lineJoin = 'round';
    ctx.beginPath();
    let started = false;
    for (let i = 0; i <= steps; i++) {
      const x = dataXMin + i * dx;
      const y = fn(x);
      if (y < yMin - 0.5 || y > yMax + 0.5) { started = false; continue; }
      const cx = toCanvasX(x);
      const cy = toCanvasY(y);
      if (!started) { ctx.moveTo(cx, cy); started = true; }
      else ctx.lineTo(cx, cy);
    }
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // ‚îÄ‚îÄ Scatter points (sin labels ‚Äî tooltip al hover) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function drawPoints(points, color) {
    points.forEach(d => {
      const cx = toCanvasX(d.duration);
      const cy = toCanvasY(d.tir);
      const r = 5;
      ctx.beginPath();
      ctx.moveTo(cx,     cy - r);
      ctx.lineTo(cx + r, cy);
      ctx.lineTo(cx,     cy + r);
      ctx.lineTo(cx - r, cy);
      ctx.closePath();
      ctx.fillStyle = color + 'cc';
      ctx.fill();
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1;
      ctx.stroke();
    });
  }

  // Draw seg√∫n tab activo
  if (curveTab === 'ny' || curveTab === 'all') {
    drawTrend(nyPoints, '#0969da');
    drawPoints(nyPoints, '#0969da');
  }
  if (curveTab === 'arg' || curveTab === 'all') {
    drawTrend(argPoints, '#cf222e');
    drawPoints(argPoints, '#cf222e');
  }

  // Store refs for tooltip
  canvas._nyPoints  = curveTab === 'arg' ? [] : nyPoints;
  canvas._argPoints = curveTab === 'ny'  ? [] : argPoints;
  canvas._toCanvasX = toCanvasX;
  canvas._toCanvasY = toCanvasY;
}

// Tooltip
(function setupTooltip() {
  const tooltip = document.createElement('div');
  tooltip.style.cssText = `
    position: fixed; pointer-events: none; display: none;
    background: #24292e; color: #fff; border-radius: 6px;
    padding: 6px 10px; font: 11px 'IBM Plex Mono', monospace;
    z-index: 300; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,.2);
    line-height: 1.6;
  `;
  document.body.appendChild(tooltip);

  document.addEventListener('mousemove', (e) => {
    const canvas = document.getElementById('yield-curve-canvas');
    if (!canvas || !canvas._nyPoints) return;

    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const allPts = [
      ...canvas._nyPoints.map(d => ({ ...d, _color: '#4da6ff' })),
      ...canvas._argPoints.map(d => ({ ...d, _color: '#ff6b6b' }))
    ];

    let closest = null;
    let minDist = Infinity;
    allPts.forEach(d => {
      const cx = canvas._toCanvasX(d.duration);
      const cy = canvas._toCanvasY(d.tir);
      const dist = Math.hypot(mx - cx, my - cy);
      if (dist < minDist) { minDist = dist; closest = d; }
    });

    if (closest && minDist < 18) {
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX + 14) + 'px';
      tooltip.style.top  = (e.clientY - 10) + 'px';
      tooltip.innerHTML = `
        <strong style="color:${closest._color}">${closest.ticker}</strong> ¬∑ ${closest.empresa}<br>
        TIR: <strong>${closest.tir.toFixed(2)}%</strong> ¬∑ Duration: <strong>${closest.duration.toFixed(2)}y</strong><br>
        Precio: $${closest.precio.toFixed(2)} ¬∑ Ley: ${closest.ley}
      `;
    } else {
      tooltip.style.display = 'none';
    }
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
render();
fetchAPI();
refreshInterval = setInterval(fetchAPI, 30000);
</script>
</body>
</html>
